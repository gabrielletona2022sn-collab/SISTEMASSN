<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Generador de Minutas ‚Äî SN PROYECTOS</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root {
    --primary: #1a2b49;
    --accent: #3b82f6;
    --bg: #f8fafc;
    --card: #ffffff;
    --text: #334155;
}

[data-theme="dark"] {
    --bg: #0f172a;
    --card: #1e293b;
    --text: #f1f5f9;
    --primary: #38bdf8;
}

body { 
    font-family: 'Outfit', sans-serif; 
    background: var(--bg); 
    color: var(--text); 
    margin: 0; 
    display: flex; 
    flex-direction: column; 
    height: 100vh;
}

/* Layout de dos columnas */
.app-container {
    display: grid;
    grid-template-columns: 400px 1fr;
    gap: 0;
    flex: 1;
    overflow: hidden;
}

/* Columna Izquierda: Formulario */
.sidebar {
    background: var(--card);
    padding: 25px;
    border-right: 1px solid rgba(0,0,0,0.1);
    overflow-y: auto;
    box-shadow: 4px 0 10px rgba(0,0,0,0.05);
}

/* Columna Derecha: Vista Previa */
.main-content {
    padding: 40px;
    overflow-y: auto;
    display: flex;
    justify-content: center;
    background: var(--bg);
}

/* La "Hoja de Papel" virtual */
.paper {
    background: white;
    width: 100%;
    max-width: 800px;
    min-height: 1000px;
    padding: 60px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    border-radius: 4px;
    color: #1a1a1a; /* Color texto legal */
    font-family: 'Times New Roman', serif;
    line-height: 1.6;
    position: relative;
}

h2 { font-size: 16px; text-transform: uppercase; letter-spacing: 1px; color: var(--primary); margin-top: 20px; }

input, textarea { 
    width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; 
    margin-bottom: 15px; box-sizing: border-box; transition: 0.2s;
    background: var(--bg); color: var(--text);
}

input:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }

button { 
    width: 100%; background: var(--primary); color: white; border: none; 
    padding: 14px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-bottom: 10px;
}

/* Toast Notification */
.toast {
    position: fixed; top: 20px; right: 20px; background: #10b981; color: white;
    padding: 12px 25px; border-radius: 8px; display: none; z-index: 1000;
    animation: slideIn 0.3s ease;
}
@keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    /* Estado de error para los inputs */
.input-error {
    border-color: #ef4444 !important; /* Rojo vibrante */
    background-color: #fef2f2 !important; /* Fondo rojizo muy suave */
    box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1) !important;
}

/* Opcional: animaci√≥n de sacudida para indicar error */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

.shake {
    animation: shake 0.2s ease-in-out 0s 2;
}
</style>
</head>
<body>

<header style="background: var(--primary); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center;">
    <span style="font-weight: 600;">‚öñÔ∏è SN PROYECTOS ‚Äî Panel de Minutas</span>
    <button onclick="toggleTheme()" id="theme-btn" style="width: auto; margin: 0; padding: 8px 15px; font-size: 12px;">üåô Modo Oscuro</button>
</header>

<div id="toast" class="toast">‚úÖ Acci√≥n realizada con √©xito</div>

<div class="app-container">
    <aside class="sidebar">
        <h2>Datos del Proyecto</h2>
        <input id="proyecto" placeholder="Nombre del proyecto">
        <input id="direccion" placeholder="Ubicaci√≥n exacta">

        <h2>Propiedad y √Årea</h2>
        <input id="propiedad" placeholder="Identificador (CASA 1-2)">
        <input id="area" placeholder="√Årea en m¬≤">

        <h2>Estaciones (Excel)</h2>
        <textarea id="estacionesTexto" style="height: 150px;" placeholder="Pegue aqu√≠ las l√≠neas de Excel..."></textarea>
        
        <button onclick="generar()" style="background: var(--accent);">üìÑ Generar Vista Previa</button>
        <button onclick="agregarAlDocumento()">‚ûï Confirmar y Acumular</button>
        
        <hr style="margin: 20px 0; opacity: 0.1;">
        
        <button onclick="exportarWord()" style="background: #10b981;">üíæ Descargar Word (.doc)</button>
        <button onclick="limpiarAcumulado()" style="background: #ef4444;">üßπ Limpiar Todo</button>
    </aside>

    <main class="main-content">
        <div class="paper">
            <div style="text-align: center; border-bottom: 2px solid #eee; margin-bottom: 30px; padding-bottom: 10px;">
                <h1 style="margin: 0; font-size: 20px; font-family: 'Outfit';">VISTA PREVIA DE MINUTA</h1>
            </div>
            
            <div id="resultado-preview" style="white-space: pre-wrap; margin-bottom: 40px; color: #3b82f6; font-weight: bold;">
                El texto generado aparecer√° aqu√≠...
            </div>

            <div style="border-top: 1px dashed #ccc; margin: 40px 0; position: relative;">
                <span style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: white; padding: 0 10px; font-size: 12px; color: #999;">DOCUMENTO ACUMULADO</span>
            </div>

            <div id="acumulado-display" style="white-space: pre-wrap; font-size: 14px;"></div>
        </div>
    </main>
</div>

<textarea id="resultado" style="display:none;"></textarea>
<textarea id="acumulado" style="display:none;"></textarea>

<script>
// --- MOTOR DE CONVERSI√ìN ---
function numeroALetras(num) {
    if (num === '' || num === null || num === undefined) return '';
    let str = num.toString().trim();
    if (str.includes('.')) {
        let partes = str.split('.');
        return numeroALetras(partes[0]) + ' punto ' + numeroALetras(partes[1]);
    }
    const unidades = ['cero','uno','dos','tres','cuatro','cinco','seis','siete','ocho','nueve'];
    const especiales = ['diez','once','doce','trece','catorce','quince'];
    const decenas = ['','diez','veinte','treinta','cuarenta','cincuenta','sesenta','setenta','ochenta','noventa'];
    const centenas = ['','ciento','doscientos','trescientos','cuatrocientos','quinientos','seiscientos','setecientos','ochocientos','novecientos'];
    let n = parseInt(str);
    if (isNaN(n)) return '';
    if (n < 10) return unidades[n];
    if (n >= 10 && n <= 15) return especiales[n - 10];
    if (n < 20) return 'dieci' + unidades[n - 10];
    if (n === 20) return 'veinte';
    if (n < 30) return 'veinti' + unidades[n - 20];
    if (n < 100) {
        let d = Math.floor(n / 10);
        let u = n % 10;
        return decenas[d] + (u ? ' y ' + unidades[u] : '');
    }
    if (n === 100) return 'cien';
    if (n < 1000) {
        let c = Math.floor(n / 100);
        let r = n % 100;
        return centenas[c] + (r ? ' ' + numeroALetras(r) : '');
    }
    if (n < 2000) return 'mil' + (n % 1000 ? ' ' + numeroALetras(n % 1000) : '');
    if (n < 1000000) {
        let m = Math.floor(n / 1000);
        let r = n % 1000;
        return numeroALetras(m) + ' mil' + (r ? ' ' + numeroALetras(r) : '');
    }
    return n.toString();
}

function convertirTexto(texto) {
    if (!texto) return '';
    return texto.replace(/\d+(?:-\d+)?(?:\.\d+)?/g, function(match) {
        if (match.includes('-')) {
            let partes = match.split('-');
            return numeroALetras(partes[0]) + ' guion ' + numeroALetras(partes[1]) + ' (' + match + ')';
        }
        return numeroALetras(match) + ' (' + match + ')';
    });
}

function generar(){
    if (!validarCampos()) return;

    let texto = `${convertirTexto(document.getElementById('propiedad').value).toUpperCase()}, ${convertirTexto(document.getElementById('proyecto').value).toUpperCase()} (QUE SI FORMAR√Å FINCA FILIAL) Finca nueva de naturaleza urbana, ubicada en ${convertirTexto(document.getElementById('direccion').value)}, con un √°rea total de ${numeroALetras(document.getElementById('area').value)} (${document.getElementById('area').value}) metros cuadrados, y con las siguientes estaciones, medidas y colindancias:\n`;
    
    let lineas = document.getElementById('estacionesTexto').value.trim().split(/\n+/);
    let errores = []; // Acumulador de errores

    lineas.forEach((l, index) => {
        let p = l.split(/\t+/);
        let numLinea = index + 1; // Para que el usuario entienda qu√© fila es

        // 1. VALIDACI√ìN DE COLUMNAS
        if(p.length < 5) {
            errores.push(`L√≠nea ${numLinea}: Faltan datos. Aseg√∫rate de copiar las 5 columnas de Excel.`);
            return;
        }

        // 2. LIMPIEZA DE DATOS (TRIM)
        let est = p[0].trim(), 
            po = p[1].trim(), 
            dato = p[2].trim(), 
            extra = p[3].trim(), 
            col = convertirTexto(p.slice(4).join(' ').trim());

        // 3. REGEX FLEXIBLE (Cero o m√°s espacios entre n√∫meros y s√≠mbolos)
        let regexGMS = /(\d+)\s*¬∞\s*(\d+)\s*'\s*(\d+)/;

        texto += `\nDe la estaci√≥n ${numeroALetras(est)} (${est}) al punto observado ${numeroALetras(po)} (${po}): `;

        try {
            if(dato.toUpperCase().startsWith('D=')){
                let gms = dato.replace(/D=\s*/i, '').match(regexGMS);
                
                // Validaci√≥n extra por si el formato de grados est√° mal
                if(!gms) throw new Error("Formato Delta incorrecto");

                let L = extra.match(/L=\s*([0-9.]+)/i)[1];
                let R = extra.match(/R=\s*([0-9.]+)/i)[1];
                texto += `Con una delta de ${numeroALetras(gms[1])} grados (${gms[1]}¬∞), ${numeroALetras(gms[2])} minutos (${gms[2]}'), ${numeroALetras(gms[3])} segundos (${gms[3]}"), una longitud de curva de ${numeroALetras(L)} (${L}) metros y un radio de ${numeroALetras(R)} (${R}) metros, colindando con ${col}; `;
            } else {
                let gms = dato.match(regexGMS);
                
                if(!gms) throw new Error("Formato Azimut incorrecto");

                texto += `Con un azimut de ${numeroALetras(gms[1])} grados (${gms[1]}¬∞), ${numeroALetras(gms[2])} minutos (${gms[2]}'), ${numeroALetras(gms[3])} segundos (${gms[3]}"), una distancia recta de ${numeroALetras(extra)} (${extra}) metros, colindando con ${col}; `;
            }
        } catch (e) {
            errores.push(`L√≠nea ${numLinea}: Error en el formato de medidas o colindancias.`);
        }
    });

    // 4. MOSTRAR ERRORES SI EXISTEN
    if (errores.length > 0) {
        alert("‚ùå No se pudo generar la minuta:\n\n" + errores.join("\n"));
        return; // Detiene la ejecuci√≥n para que no salga texto incompleto
    }

    document.getElementById('resultado').value = texto;
    // Actualiza la hoja de papel visual
document.getElementById('resultado-preview').innerText = texto;
mostrarNotificacion("Vista previa generada");
}

// --- FUNCIONES DE INTERFAZ ---
function toggleTheme() {
    let theme = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem('theme', theme);
    updateThemeBtn(theme);
}

function updateThemeBtn(theme) {
    const btn = document.getElementById('theme-btn');
    btn.innerHTML = theme === "dark" ? "‚òÄÔ∏è Modo Claro" : "üåô Modo Oscuro";
}

function validarCampos() {
function validarCampos() {
    // Lista de IDs que deben estar llenos
    let campos = ['proyecto', 'direccion', 'propiedad', 'area', 'estacionesTexto'];
    let valido = true;
    
    campos.forEach(id => {
        let el = document.getElementById(id);
        if (!el.value.trim()) { 
            el.classList.add('input-error'); // Pone el borde rojo
            el.classList.add('shake');      // Le da un peque√±o movimiento
            valido = false; 
            
            // Quita la sacudida despu√©s de que termine la animaci√≥n
            setTimeout(() => el.classList.remove('shake'), 400);
        } else { 
            el.classList.remove('input-error'); 
        }
    });

    if (!valido) {
        mostrarNotificacion("‚ö†Ô∏è Por favor, completa los campos resaltados");
    }
    
    return valido;
}

function agregarAlDocumento() {
    const res = document.getElementById('resultado');
    const acu = document.getElementById('acumulado');
    
    if (!res.value) { 
        mostrarNotificacion("‚ö†Ô∏è Genera la minuta primero"); 
        return; 
    }

    let sep = acu.value.trim() ? "\n\n--------------------------------------------\n\n" : "";
    acu.value += sep + res.value;
    
    // --- NUEVAS L√çNEAS DE VISUALIZACI√ìN ---
    // Actualiza el acumulado visual en la hoja de papel derecha
    document.getElementById('acumulado-display').innerText = acu.value;
    // Limpia el preview temporal para indicar que ya se guard√≥
    document.getElementById('resultado-preview').innerText = "Esperando nueva generaci√≥n...";
    // Notificaci√≥n elegante en lugar de alert
    mostrarNotificacion("‚úÖ Agregado al documento correctamente");
    // ---------------------------------------

    // Limpieza parcial de inputs para la siguiente propiedad
    document.getElementById('propiedad').value = "";
    document.getElementById('area').value = "";
    document.getElementById('estacionesTexto').value = "";
    res.value = "";

    // Actualizaci√≥n de la barra de progreso
    document.getElementById('progress-container').style.display = 'block';
    let bloques = acu.value.split('--------------------------------------------').length;
    document.getElementById('progress-bar').style.width = Math.min(bloques * 10, 100) + "%";

    guardarProgreso();
}

function guardarProgreso() {
    const data = {
        acu: document.getElementById('acumulado').value,
        proy: document.getElementById('proyecto').value,
        dir: document.getElementById('direccion').value
    };
    localStorage.setItem('minuta_sn', JSON.stringify(data));
}

function limpiarAcumulado() {
    if(confirm("¬øBorrar todo el documento acumulado?")) {
        document.getElementById('acumulado').value = "";
        document.getElementById('progress-container').style.display = 'none';
        guardarProgreso();
    }
}

window.onload = function() {
    const saved = localStorage.getItem('minuta_sn');
    if (saved) {
        const d = JSON.parse(saved);
        document.getElementById('acumulado').value = d.acu || "";
        document.getElementById('proyecto').value = d.proy || "";
        document.getElementById('direccion').value = d.dir || "";
    }
    const theme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute("data-theme", theme);
    updateThemeBtn(theme);
};

function copiarDocumento() {
    navigator.clipboard.writeText(document.getElementById('acumulado').value).then(() => alert("üìã Copiado al portapapeles"));
}

function exportarWord() {
    // Tomamos el contenido del acumulado (el texto real)
    const contenido = document.getElementById("acumulado").value;
    
    if (!contenido) {
        mostrarNotificacion("‚ö†Ô∏è El documento est√° vac√≠o");
        return;
    }

    // Nombre del proyecto para el nombre del archivo
    const nombreProy = document.getElementById('proyecto').value || "MINUTA";
    const nombreArchivo = `MINUTA_${nombreProy.toUpperCase()}.doc`;

    // Estructura HTML profesional para Word (incluye m√°rgenes y fuentes)
    const html = `
    <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
    <head>
        <meta charset='utf-8'>
        <style>
            @page Section1 {
                size: 8.5in 11in; /* Tama√±o Carta */
                margin: 1in 1.25in 1in 1.25in; /* M√°rgenes est√°ndar */
                mso-header-margin: .5in;
                mso-footer-margin: .5in;
                mso-paper-source: 0;
            }
            div.Section1 { page: Section1; }
            body {
                font-family: 'Times New Roman', serif;
                font-size: 12pt;
                text-align: justify;
                line-height: 1.5;
            }
        </style>
    </head>
    <body>
        <div class="Section1">
            ${contenido.replace(/\n/g, '<br>')}
        </div>
    </body>
    </html>`;

    // Crear el archivo y descargarlo
    const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = nombreArchivo;
    document.body.appendChild(link); // Necesario en algunos navegadores
    link.click();
    document.body.removeChild(link);
    
    mostrarNotificacion("üíæ Documento Word descargado");
}
function mostrarNotificacion(msj) {
    const t = document.getElementById('toast');
    t.innerText = msj;
    t.style.display = 'block';
    setTimeout(() => { t.style.display = 'none'; }, 3000);
}
</script>
</body>
</html>
